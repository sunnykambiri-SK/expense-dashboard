<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EXPENSE TRACKER</title>

  <!-- INR App Icon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%230059b3'/%3E%3Ctext x='50' y='63' font-size='55' text-anchor='middle' fill='white' font-family='Arial'%3E%E2%82%B9%3C/text%3E%3C/svg%3E" />

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .card { box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06); }
    .collapsible-arrow { transition: transform 0.2s ease; }
    .collapsible-arrow.open { transform: rotate(90deg); }

    /* Burn bar thickness */
    .burn-bar-bg {
      height: 20px;
    }
    .burn-bar-fg {
      height: 20px;
    }
  </style>
</head>

<body class="bg-indigo-100 min-h-screen">
  <main class="max-w-xl mx-auto px-4 py-4 space-y-4">

    <!-- HEADER -->
    <header class="flex items-center justify-between mb-2">
      <h1 class="text-lg font-extrabold tracking-wide text-slate-900">EXPENSE TRACKER</h1>
      <div class="flex items-center gap-2">
        <div id="data-badge" class="hidden px-2 py-0.5 rounded bg-amber-500 text-white text-[10px] font-semibold uppercase">
          Sample
        </div>
        <div id="month-pill" class="px-3 py-1 rounded-md bg-orange-500 text-white text-xs font-semibold uppercase">---</div>
      </div>
    </header>

    <!-- SUMMARY -->
    <section id="summary-card" class="card rounded-xl bg-[#f5f0e6] px-4 py-3">
      <div class="flex justify-between text-xs font-semibold text-slate-600 mb-1">
        <span>THIS MONTH</span>
      </div>

      <div class="flex gap-4">
        <div class="flex-1">
          <div class="text-xs font-semibold text-indigo-700 mb-0.5">Total Spent</div>
          <div id="summary-total" class="text-xl font-extrabold text-indigo-700">₹0</div>
        </div>

        <div class="flex-1 text-right">
          <div class="text-xs font-semibold text-slate-800 mb-0.5">Balance</div>
          <div id="summary-balance" class="text-xl font-extrabold text-black">₹0</div>
        </div>
      </div>
    </section>

    <!-- BURN RATE -->
    <section id="burn-card" class="card rounded-xl bg-white px-4 py-3">
      <div class="flex justify-between text-[11px] text-slate-600 mb-1">
        <span>Time elapsed: <span id="burn-time">0%</span></span>
        <span>Burn: <span id="burn-spent">0%</span></span>
      </div>

      <div class="relative w-full bg-slate-200 rounded-full burn-bar-bg overflow-hidden">
        <div id="burn-time-bar" class="absolute left-0 top-0 bg-blue-400/70 burn-bar-fg rounded-full" style="width:0%"></div>
        <div id="burn-spent-bar" class="absolute left-0 top-0 burn-bar-fg rounded-full bg-emerald-500" style="width:0%"></div>
      </div>
    </section>

    <!-- LAST 10D TREND -->
    <section id="trend-card" class="card rounded-xl bg-white px-4 py-3">
      <h2 class="text-sm font-semibold text-slate-800 mb-2">Last 10D trend</h2>
      <div id="trend-chart" class="relative flex items-end space-x-1 h-40"></div>
    </section>

    <!-- CATEGORY (COLLAPSIBLE) -->
    <section class="card rounded-xl bg-white">
      <button id="cat-header" class="w-full flex items-center justify-between px-4 py-3 text-sm font-semibold text-slate-800">
        <span>Category</span>
        <span id="cat-arrow" class="collapsible-arrow text-slate-500">▶</span>
      </button>
      <div id="cat-body" class="border-t border-slate-100 px-4 py-2 hidden">
        <div id="cat-list" class="space-y-2"></div>
      </div>
    </section>

    <!-- RECENT TRANSACTIONS -->
    <section id="tx-card" class="card rounded-xl bg-white">
      <button id="tx-header" class="w-full flex items-center justify-between px-4 py-3 text-sm font-semibold text-slate-800">
        <span>Recent Transactions</span>
        <span id="tx-arrow" class="collapsible-arrow text-slate-500">▶</span>
      </button>

      <div id="tx-body" class="border-t border-slate-100 px-4 py-2 hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full text-[11px] text-left text-slate-700 border-separate border-spacing-y-1">
            <thead>
              <tr class="text-[10px] uppercase text-slate-400">
                <th class="pr-2">Date</th>
                <th class="pr-2">What</th>
                <th class="pr-2">By</th>
                <th class="pr-2 text-right">Amount</th>
              </tr>
            </thead>
            <tbody id="tx-table-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CONTRIBUTION -->
    <section id="contri-card" class="card rounded-xl bg-white px-4 py-3">
      <h2 class="text-sm font-semibold text-slate-800 mb-2">Contribution</h2>
      <div class="flex justify-between text-[11px] text-slate-400 mb-1">
        <span>Sunny</span>
        <span>Deepal</span>
      </div>
      <div class="w-full h-5 bg-slate-200 rounded-full overflow-hidden flex" id="contri-bar-wrapper"></div>
    </section>

    <!-- HISTORY -->
    <section class="card rounded-xl bg-white">
      <button id="hist-header" class="w-full flex items-center justify-between px-4 py-3 text-sm font-semibold text-slate-800">
        <span>History</span>
        <span id="hist-arrow" class="collapsible-arrow text-slate-500">▶</span>
      </button>
      <div id="hist-body" class="border-t border-slate-100 px-4 py-2 hidden">
        <div id="hist-list" class="space-y-1 text-[12px]"></div>
      </div>
    </section>

    <!-- FILTERS -->
    <section class="card rounded-xl bg-white">
      <button id="filter-header" class="w-full flex items-center justify-between px-4 py-3 text-sm font-semibold text-slate-800">
        <span>Filters</span>
        <span id="filter-arrow" class="collapsible-arrow text-slate-500">▶</span>
      </button>
      <div id="filter-body" class="border-t border-slate-100 px-4 py-3 hidden">
        <div class="grid grid-cols-2 gap-2 text-[11px]">
          <div>
            <label class="block text-slate-500 mb-1">From</label>
            <input id="filter-from" type="date" class="w-full rounded border border-slate-300 px-2 py-1 text-[11px]" />
          </div>
          <div>
            <label class="block text-slate-500 mb-1">To</label>
            <input id="filter-to" type="date" class="w-full rounded border border-slate-300 px-2 py-1 text-[11px]" />
          </div>
          <div>
            <label class="block text-slate-500 mb-1">Category</label>
            <select id="filter-category" class="w-full rounded border border-slate-300 px-2 py-1 text-[11px]">
              <option value="all">All</option>
            </select>
          </div>
          <div>
            <label class="block text-slate-500 mb-1">Person</label>
            <select id="filter-person" class="w-full rounded border border-slate-300 px-2 py-1 text-[11px]">
              <option value="all">All</option>
              <option value="Sunny">Sunny</option>
              <option value="Deepal">Deepal</option>
              <option value="Nishka">Nishka</option>
              <option value="Others">Others</option>
            </select>
          </div>
          <div>
            <label class="block text-slate-500 mb-1">Min Amount</label>
            <input id="filter-min" type="number" class="w-full rounded border border-slate-300 px-2 py-1 text-[11px]" placeholder="0" />
          </div>
          <div class="flex items-end">
            <button id="filter-apply" class="w-full rounded bg-indigo-600 text-white text-[11px] py-1 font-semibold">
              Apply
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- ADD BUTTON -->
    <a href="https://docs.google.com/forms/d/1hnsgJRRX_1vcoo9bmIXVzTih__gkM_ltXX5DvxLtkGc/viewform"
       target="_blank"
       class="fixed bottom-6 right-6 z-50 flex items-center justify-center w-14 h-14 rounded-full bg-indigo-600 text-white shadow-xl">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M12 4v16" stroke="white" stroke-width="2" stroke-linecap="round"/>
        <path d="M20 12H4" stroke="white" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </a>
  </main>

<script>
/* CONFIG */
const G_SHEET_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vSg2yv6cZgH_d8f7gFlb3P44ZO3_DubKK0kzmnlDYdOkB2hWwv3TVUWUPnywnhG-_ECKvqUE21-aCRC/pub?output=csv";
const MONTHLY_BUDGET=50000;
const DAILY_LIMIT=2000;
const SAMPLE_CSV=`Timestamp,What was the money spent on,Amount,Entered By,Date,Main Expense Category
12/2/2025 23:19:46,Food,300,Sunny,12/2/2025,Food
12/3/2025 09:10:00,Taxi,250,Deepal,12/3/2025,Taxi / Commute
12/3/2025 20:30:00,Dinner,1200,Sunny,12/3/2025,Outings Lunches/Dinners
12/4/2025 11:05:00,Grocery,800,Deepal,12/4/2025,Grocery`;

let ALL_EXPENSES=[];

/* PARSE CSV (column 3 is now 'Spent on' but position is same) */
function parseCSV(text){
  const rows=text.split(/\r?\n/).filter(r=>r.trim().length),out=[];
  for(let i=1;i<rows.length;i++){
    const cols=rows[i].split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(c=>c.replace(/"/g,'').trim());
    if(!cols.length||!cols[0])continue;
    const[timestamp,details,amount,enteredBy,dateRaw,category]=cols;
    out.push({
      timestamp,
      details,
      amount:Number((amount||'0').replace(/,/g,''))||0,
      enteredBy,               // this now carries: Sunny / Deepal / Nishka / Others
      date:dateRaw||timestamp.split(' ')[0],
      category:category||'OTHERS'
    });
  }
  return out;
}

function normalizeDateStr(d){
  const p=String(d).split('/');
  return p.length===3?`${p[2]}-${String(p[0]).padStart(2,'0')}-${String(p[1]).padStart(2,'0')}`:d;
}

function getMonthKey(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}

function filterCurrentMonth(rows){
  const now=new Date(),m=getMonthKey(now);
  return rows.filter(e=>getMonthKey(new Date(e.dateISO||e.date))===m);
}

function setMonthPill(){
  document.getElementById('month-pill').textContent=
    new Date().toLocaleString('en-US',{month:'short'}).toLowerCase();
}

function renderSummary(exp){
  const t=exp.reduce((s,e)=>s+e.amount,0);
  document.getElementById('summary-total').textContent='₹'+t.toLocaleString('en-IN');
  document.getElementById('summary-balance').textContent='₹'+(MONTHLY_BUDGET-t).toLocaleString('en-IN');
}

function renderBurn(exp){
  const total=exp.reduce((s,e)=>s+e.amount,0),
        now=new Date(),
        days=new Date(now.getFullYear(),now.getMonth()+1,0).getDate(),
        day=now.getDate(),
        timePct=Math.round(day/days*100),
        spentPct=Math.round(total/MONTHLY_BUDGET*100);
  document.getElementById('burn-time').textContent=timePct+'%';
  document.getElementById('burn-spent').textContent=spentPct+'%';
  document.getElementById('burn-time-bar').style.width=timePct+'%';
  const bar=document.getElementById('burn-spent-bar');
  bar.style.width=Math.min(spentPct,100)+'%';
  bar.classList.remove('bg-emerald-500','bg-red-500');
  bar.classList.add(spentPct>timePct?'bg-red-500':'bg-emerald-500');
}

/* LAST 10D TREND */
function renderTrend(rows){
  const c=document.getElementById('trend-chart');c.innerHTML='';
  const today=new Date();today.setHours(0,0,0,0);

  const totals={};
  rows.forEach(e=>{
    const d=new Date(e.dateISO||e.date);d.setHours(0,0,0,0);
    const key=d.toISOString().slice(0,10);
    totals[key]=(totals[key]||0)+e.amount;
  });

  const days=[];
  for(let i=9;i>=0;i--){
    const d=new Date(today);d.setDate(d.getDate()-i);
    const key=d.toISOString().slice(0,10);
    days.push({
      key,
      label:`${String(d.getDate()).padStart(2,'0')}/${d.getMonth()+1}`,
      total:totals[key]||0
    });
  }

  const max=Math.max(...days.map(d=>d.total),1);

  days.forEach(e=>{
    const pct=max===0?0:e.total/max*80;
    const box=document.createElement('div');
    box.className='flex flex-col items-center flex-1 h-full';

    const val=document.createElement('div');
    val.className='text-[10px] text-slate-600';
    val.style.transform='rotate(-90deg)';
    val.textContent=e.total?e.total.toLocaleString('en-IN'):'';
    box.appendChild(val);

    const outer=document.createElement('div');
    outer.className='flex-1 flex items-end w-full justify-center';
    const col=document.createElement('div');
    col.className='w-[60%] rounded-t '+(e.total>DAILY_LIMIT?'bg-red-500':'bg-indigo-500');
    col.style.height=pct+'%';
    outer.appendChild(col);
    box.appendChild(outer);

    const date=document.createElement('span');
    date.className='text-[10px] text-slate-500 mt-1';
    date.textContent=e.label;
    box.appendChild(date);

    c.appendChild(box);
  });
}

/* CATEGORIES */
function renderCategories(exp){
  const el=document.getElementById('cat-list');el.innerHTML='';
  if(!exp.length)return(el.innerHTML='<p class="text-xs text-slate-500">No data</p>');
  const totals={},sum=exp.reduce((s,e)=>s+e.amount,0);
  exp.forEach(e=>totals[e.category]=(totals[e.category]||0)+e.amount);
  const maxVal = Math.max(...Object.values(totals),1);
  Object.entries(totals).sort((a,b)=>b[1]-a[1]).forEach(([c,a])=>{
    const pct=(a/maxVal)*90,
          p=Math.round(a/sum*100);
    el.innerHTML+=`
<div class="text-[11px]">
  <div class="flex justify-between mb-0.5">
    <span class="font-semibold text-slate-800">${c} (${p}%)</span>
  </div>
  <div class="w-full bg-slate-200 h-4 rounded-md overflow-hidden">
    <div class="h-4 bg-indigo-500 rounded-md relative" style="width:${pct}%">
      <span class="absolute right-1 top-1/2 -translate-y-1/2 text-[10px] text-white font-semibold">₹${a.toLocaleString('en-IN')}</span>
    </div>
  </div>
</div>`;
  });
}

/* TRANSACTIONS */
function renderTransactions(exp){
  const t=document.getElementById('tx-table-body');t.innerHTML='';
  if(!exp.length)return(t.innerHTML='<tr><td colspan="4" class="text-center text-xs text-slate-500 py-2">No expenses this month.</td></tr>');
  exp.sort((a,b)=>new Date(b.dateISO||b.date)-new Date(a.dateISO||a.date))
    .forEach(e=>{
      const d=new Date(e.dateISO||e.date);
      t.innerHTML+=`
<tr>
  <td class="pr-2">${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}</td>
  <td class="pr-2 truncate max-w-[120px]">${e.details}</td>
  <td class="pr-2">${e.enteredBy}</td>
  <td class="pr-2 text-right">₹${e.amount.toLocaleString('en-IN')}</td>
</tr>`;
    });
}

/* CONTRIBUTION — UPDATED FOR Sunny / Deepal / Nishka / Others (Option B) */
function renderContribution(exp){
  const c=document.getElementById('contri-bar-wrapper');
  c.innerHTML='';

  // Totals by person
  const totals = { Sunny: 0, Deepal: 0, Nishka: 0, Others: 0 };
  exp.forEach(e => {
    const who = e.enteredBy;
    if (totals.hasOwnProperty(who)) {
      totals[who] += e.amount;
    }
  });

  // Only show people who actually have >0 spend
  const entries = Object.entries(totals).filter(([, amt]) => amt > 0);
  const total = entries.reduce((sum, [, amt]) => sum + amt, 0);

  if (!total || !entries.length) {
    c.innerHTML = '<div class="w-full text-center text-xs text-slate-500 py-1">No data</div>';
    return;
  }

  const colors = {
    Sunny: 'bg-red-500',
    Deepal: 'bg-emerald-500',
    Nishka: 'bg-purple-500',
    Others: 'bg-gray-500'
  };

  entries.forEach(([name, amt]) => {
    const pct = (amt / total) * 100;
    const div = document.createElement('div');
    div.className = `h-full flex items-center justify-center text-[10px] text-white font-semibold ${colors[name]}`;
    div.style.width = pct + '%';
    div.textContent = Math.round(pct) + '%';
    c.appendChild(div);
  });
}

/* HISTORY */
function renderHistory(rows){
  const el=document.getElementById('hist-list');el.innerHTML='';
  const map={};
  rows.forEach(e=>{
    const k=getMonthKey(new Date(e.dateISO||e.date));
    map[k]=(map[k]||0)+e.amount;
  });
  const now=getMonthKey(new Date()),
        out=Object.entries(map).filter(([k])=>k!==now).sort((a,b)=>b[0].localeCompare(a[0]));
  if(!out.length)return(el.innerHTML='<p class="text-xs text-slate-500">No previous months.</p>');
  out.forEach(([k,a])=>{
    const[year,month]=k.split('-').map(Number);
    const d=new Date(year,month-1,1);
    el.innerHTML+=`<div class="flex justify-between"><span>${d.toLocaleString('en-US',{month:'long',year:'numeric'})}</span><span class="font-semibold text-indigo-700">₹${a.toLocaleString('en-IN')}</span></div>`;
  });
}

/* COLLAPSIBLES */
function setupCollapsibles(){
  [['cat','cat'],['tx','tx'],['hist','hist'],['filter','filter']]
    .forEach(([id,a])=>{
      document.getElementById(`${id}-header`).addEventListener('click',()=>{
        document.getElementById(`${id}-body`).classList.toggle('hidden');
        document.getElementById(`${a}-arrow`).classList.toggle('open');
      });
    });
}

/* FILTERS */
function populateCategoryFilter(rows){
  const sel=document.getElementById('filter-category'),set=new Set();
  sel.querySelectorAll('option:not([value="all"])').forEach(o=>o.remove());
  rows.forEach(e=>set.add(e.category));
  [...set].sort().forEach(c=>{
    const o=document.createElement('option');o.value=c;o.textContent=c;sel.appendChild(o);
  });
}

function applyFilters(){
  const f=document.getElementById('filter-from').value,
        t=document.getElementById('filter-to').value,
        cat=document.getElementById('filter-category').value,
        p=document.getElementById('filter-person').value,
        m=Number(document.getElementById('filter-min').value||0);
  return ALL_EXPENSES.filter(e=>{
    const d=new Date(e.dateISO||e.date);
    if(f&&d<new Date(f+'T00:00:00'))return false;
    if(t&&d>new Date(t+'T23:59:59'))return false;
    if(cat!=='all'&&e.category!==cat)return false;
    if(p!=='all'&&e.enteredBy!==p)return false;
    if(e.amount<m)return false;
    return true;
  });
}

/* LOAD + INIT */
async function loadExpenses(){
  setMonthPill();
  let txt,useSample=false;
  try{
    const r=await fetch(G_SHEET_URL,{cache:'no-store'});
    if(!r.ok)throw 0;txt=await r.text();
  }catch{
    txt=SAMPLE_CSV;useSample=true;
  }
  if(useSample)document.getElementById('data-badge').classList.remove('hidden');
  ALL_EXPENSES=parseCSV(txt).map(e=>({...e,dateISO:normalizeDateStr(e.date)}));
}

async function init(){
  await loadExpenses();
  populateCategoryFilter(ALL_EXPENSES);
  const rows=applyFilters(),mon=filterCurrentMonth(rows);
  renderSummary(mon);
  renderBurn(mon);
  renderTrend(rows);
  renderCategories(mon);
  renderTransactions(mon);
  renderContribution(mon);
  renderHistory(rows);
  setupCollapsibles();

  document.getElementById('filter-apply').addEventListener('click',()=>{
    const rows=applyFilters(),mon=filterCurrentMonth(rows);
    renderSummary(mon);
    renderBurn(mon);
    renderTrend(rows);
    renderCategories(mon);
    renderTransactions(mon);
    renderContribution(mon);
    renderHistory(rows);
  });
}

init();
</script>
</body>
</html>
