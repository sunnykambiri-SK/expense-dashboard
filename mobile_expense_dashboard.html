<!DOCTYPE html>
<html lang="en">
<head>
  <!-- App Icon for Home‑Screen Shortcut (INR symbol) -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%230059b3'/%3E%3Ctext x='50' y='63' font-size='55' text-anchor='middle' fill='white' font-family='Arial'%3E%E2%82%B9%3C/text%3E%3C/svg%3E" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Expense Dashboard – Live Data</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Basic safe styles to avoid flash of unstyled content */
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
  </style>
</head>
<body class="bg-indigo-100 p-4">

<h2 class="text-xl font-bold mb-4">Joint Expense Dashboard (Live)</h2>

<script>
// ====== SAFETY: define a placeholder init so other script blocks can reference it without ReferenceError ======
window.init = window.init || (async function placeholderInit(){
  // placeholder - will be replaced by actual implementations below
  console.debug('placeholder init (no-op)');
});

// ---- CONFIG ----
const USE_DUMMY_DATA = false;
const G_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSg2yv6cZgH_d8f7gFlb3P44ZO3_DubKK0kzmnlDYdOkB2hWwv3TVUWUPnywnhG-_ECKvqUE21-aCRC/pub?output=csv";

// CSV Columns (according to your sheet)
// 0: Timestamp
// 1: What was the money spent on
// 2: Amount
// 3: Entered By
// 4: Date
// 5: Main Expense Category

async function fetchCSV() {
  if (USE_DUMMY_DATA) return [];
  try {
    const res = await fetch(G_SHEET_URL);
    if (!res.ok) throw new Error('Failed to fetch CSV: ' + res.status);
    const text = await res.text();
    return parseCSV(text);
  } catch (err) {
    console.error('fetchCSV error', err);
    return [];
  }
}

function parseCSV(csvText) {
  if (!csvText) return [];
  const rows = csvText.split(/\r?\n/).filter(r => r.trim().length);
  const data = [];

  for (let i = 1; i < rows.length; i++) {
    const cols = rows[i].split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/);
    const clean = cols.map(c => (c || '').replace(/"/g, '').trim());

    // defensive mapping - guard missing columns
    const timestamp = clean[0] || '';
    const details = clean[1] || '';
    const amount = Number(clean[2] ? clean[2].replace(/,/g, '') : 0) || 0;
    const enteredBy = clean[3] || '';
    const date = clean[4] || timestamp.split(' ')[0] || '';
    const category = (clean[5] && clean[5].trim()) || 'OTHERS';

    data.push({ timestamp, details, amount, enteredBy, date, category });
  }
  return data;
}

// Base initializer: renders a simple preview (keeps previous behavior)
async function baseInit() {
  const expenses = await fetchCSV();
  console.log('Loaded expenses (baseInit):', expenses.length);

  // Remove any existing preview container to avoid duplicates
  const existing = document.getElementById('preview-container');
  if (existing) existing.remove();

  const container = document.createElement('div');
  container.id = 'preview-container';
  container.className = 'bg-white p-4 rounded shadow mt-4';

  if (expenses.length === 0) {
    container.innerHTML = '<p class="text-sm text-gray-500">No expenses found (check sheet publishing & URL).</p>';
    document.body.appendChild(container);
    return expenses;
  }

  expenses.slice(0, 10).forEach(e => {
    const div = document.createElement('div');
    div.className = 'border-b py-2';
    div.innerHTML = `
      <div class='font-semibold'>${e.details || '(no details)'}</div>
      <div class='text-sm text-gray-500'>${e.date} • ${e.category} • ${e.enteredBy}</div>
      <div class='font-bold text-indigo-700'>₹${e.amount}</div>
    `;
    container.appendChild(div);
  });

  document.body.appendChild(container);
  return expenses;
}

// Assign baseInit as the initial init implementation (so other patches can capture it)
window.init = baseInit;

// Immediately call init once to show initial preview (will be called again by patches)
window.init();
</script>


<!-- STEP 1: Monthly Summary UI (Total / Sunny / Deepal) -->
<div id="summary-card" class="bg-white p-4 rounded-xl shadow-md mb-6 border border-indigo-200">
  <h3 class="text-lg font-bold text-indigo-700 mb-2">This Month Summary</h3>
  <div class="flex justify-between text-sm font-semibold text-gray-700">
    <div>Total Spent:</div>
    <div id="total-spent">₹0</div>
  </div>
  <div class="flex justify-between text-sm mt-2">
    <div class="text-red-600 font-semibold">Sunny</div>
    <div id="sunny-total" class="font-bold text-red-600">₹0</div>
  </div>
  <div class="flex justify-between text-sm mt-1">
    <div class="text-green-600 font-semibold">Deepal</div>
    <div id="deepal-total" class="font-bold text-green-600">₹0</div>
  </div>
  <p id="summary-month" class="text-xs text-gray-500 mt-3"></p>
</div>

<script>
// --- STEP 1: COMPUTE MONTH LEVEL TOTALS ---
function computeMonthlyTotals(expenses) {
  const today = new Date();
  const month = today.getMonth() + 1;
  const year = today.getFullYear();

  const monthly = expenses.filter(e => {
    // e.date expected as MM/DD/YYYY or already normalized YYYY-MM-DD
    const d = new Date(e.date);
    return d.getFullYear() === year && (d.getMonth() + 1) === month;
  });

  let total = 0;
  let sunny = 0;
  let deepal = 0;

  monthly.forEach(e => {
    total += Number(e.amount) || 0;
    if (String(e.enteredBy).trim() === 'Sunny') sunny += Number(e.amount) || 0;
    if (String(e.enteredBy).trim() === 'Deepal') deepal += Number(e.amount) || 0;
  });

  document.getElementById('total-spent').textContent = `₹${total}`;
  document.getElementById('sunny-total').textContent = `₹${sunny}`;
  document.getElementById('deepal-total').textContent = `₹${deepal}`;

  const monthName = today.toLocaleString('en-US', { month: 'long', year: 'numeric' });
  document.getElementById('summary-month').textContent = `Showing data for ${monthName}`;

  return monthly;
}

// Patchable init: capture current init and wrap
(function patchStep1(){
  const _oldInit = window.init;
  window.init = async function step1Init(){
    const expenses = await fetchCSV();
    computeMonthlyTotals(expenses);
    if (typeof _oldInit === 'function') await _oldInit();
  };
})();
</script>


<!-- STEP 2: Recent Transactions (Collapsible) -->
<div id="tx-card" class="bg-white p-4 rounded-xl shadow-md mb-6 border border-indigo-200">
  <div id="tx-header" class="flex justify-between items-center cursor-pointer select-none">
    <h3 class="text-lg font-bold text-indigo-700">Recent Transactions</h3>
    <span id="tx-arrow" class="transition-transform">▶</span>
  </div>
  <div id="tx-list" class="mt-3 hidden"></div>
</div>

<script>
// Toggle collapsible
function setupTxCollapsible() {
  const header = document.getElementById('tx-header');
  const arrow = document.getElementById('tx-arrow');
  const list = document.getElementById('tx-list');

  header.onclick = () => {
    const isHidden = list.classList.contains('hidden');
    if (isHidden) {
      list.classList.remove('hidden');
      arrow.style.transform = 'rotate(90deg)';
    } else {
      list.classList.add('hidden');
      arrow.style.transform = 'rotate(0deg)';
    }
  };
}

// Render recent transactions
function renderTransactions(monthExpenses) {
  const list = document.getElementById('tx-list');
  list.innerHTML = '';

  if (!monthExpenses || monthExpenses.length === 0) {
    list.innerHTML = `<p class='text-sm text-gray-500 italic'>No expenses recorded this month.</p>`;
    return;
  }

  // Sort newest → oldest
  monthExpenses.sort((a,b) => new Date(b.date) - new Date(a.date));

  monthExpenses.forEach(e => {
    const color = String(e.enteredBy).trim() === 'Sunny' ? 'red' : 'green';

    const item = document.createElement('div');
    item.className = 'border-b py-3';
    item.innerHTML = `
      <div class='font-semibold'>${e.details}</div>
      <div class='text-xs text-gray-500 flex items-center gap-2'>
        <span>${e.date}</span>
        <span class='px-2 py-0.5 text-white rounded-full text-[10px] bg-${color}-500'>${e.enteredBy}</span>
        <span class='text-gray-600'>• ${e.category}</span>
      </div>
      <div class='font-bold text-indigo-700 mt-1'>₹${e.amount}</div>
    `;

    list.appendChild(item);
  });
}

// Patchable init for step 2
(function patchStep2(){
  const _oldInit = window.init;
  window.init = async function step2Init(){
    const expenses = await fetchCSV();
    const monthList = computeMonthlyTotals(expenses);
    renderTransactions(monthList);
    setupTxCollapsible();
    if (typeof _oldInit === 'function') await _oldInit();
  };
})();
</script>


<!-- STEP 3: Budget vs Actual Burn Rate -->
<div id="burn-card" class="bg-white p-4 rounded-xl shadow-md mb-6 border border-indigo-200">
  <h3 class="text-lg font-bold text-indigo-700 mb-2">Budget vs Actual Burn Rate</h3>

  <div class="flex justify-between text-sm text-gray-700 mb-1">
    <span>Time Elapsed:</span>
    <span id="burn-time">0%</span>
  </div>

  <div class="flex justify-between text-sm text-gray-700 mb-1">
    <span>Budget Spent:</span>
    <span id="burn-spent">0%</span>
  </div>

  <!-- Progress Bar -->
  <div class="relative w-full h-3 bg-gray-200 rounded-full mt-3">
    <!-- Time Progress -->
    <div id="burn-time-bar" class="absolute h-3 bg-blue-400 rounded-full opacity-70" style="width:0%"></div>
    <!-- Spending Progress -->
    <div id="burn-spent-bar" class="absolute h-3 rounded-full" style="width:0%"></div>
  </div>

  <p id="burn-tip" class="text-xs text-gray-500 mt-2 italic"></p>
</div>

<script>
const MONTHLY_BUDGET = 50000;
function computeBurnRate(totalSpent) {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end = new Date(now.getFullYear(), now.getMonth()+1, 0);

  const totalDays = end.getDate();
  const daysPassed = now.getDate();

  const timeRatio = daysPassed / totalDays;
  const spentRatio = totalSpent / MONTHLY_BUDGET;

  document.getElementById('burn-time').textContent = Math.round(timeRatio * 100) + '%';
  document.getElementById('burn-spent').textContent = Math.round(spentRatio * 100) + '%';

  document.getElementById('burn-time-bar').style.width = (timeRatio * 100) + '%';

  const spentBar = document.getElementById('burn-spent-bar');
  spentBar.style.width = Math.min(spentRatio * 100, 100) + '%';
  spentBar.classList.remove('bg-green-500','bg-red-500');
  spentBar.classList.add(spentRatio > timeRatio ? 'bg-red-500' : 'bg-green-500');

  let tip = 'On track.';
  if (spentRatio > 1) tip = 'You are over the monthly budget!';
  else if (spentRatio > timeRatio) tip = 'Warning: Spending faster than time.';
  document.getElementById('burn-tip').textContent = tip;
}

// Patchable init for step 3
(function patchStep3(){
  const _oldInit = window.init;
  window.init = async function step3Init(){
    const expenses = await fetchCSV();
    const monthList = computeMonthlyTotals(expenses);

    const totalSpent = monthList.reduce((sum,e) => sum + Number(e.amount || 0), 0);
    computeBurnRate(totalSpent);

    renderTransactions(monthList);
    setupTxCollapsible();

    if (typeof _oldInit === 'function') await _oldInit();
  };
})();
</script>


<!-- STEP 4: Last 10 Days Trend Chart -->
<div id="trend-card" class="bg-white p-4 rounded-xl shadow-md mb-6 border border-indigo-200">
  <h3 class="text-lg font-bold text-indigo-700 mb-3">Last 10 Days Trend</h3>
  <div id="trend-chart" class="flex items-end space-x-1 h-40 relative"></div>
</div>

<script>
const TREND_DAYS = 10;
function makeDateKey(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function renderTrend(expenses) {
  const chart = document.getElementById('trend-chart');
  chart.innerHTML = '';

  const today = new Date(); today.setHours(0,0,0,0);
  const days = {};
  for (let i = 0; i < TREND_DAYS; i++) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    days[makeDateKey(d)] = { total: 0, label: d.getDate() + '/' + (d.getMonth()+1) };
  }

  expenses.forEach(e => {
    const d = new Date(e.date);
    d.setHours(0,0,0,0);
    const key = makeDateKey(d);
    if (days[key]) days[key].total += Number(e.amount || 0);
  });

  const ordered = Object.keys(days).sort();
  const values = ordered.map(k => days[k].total);
  const max = Math.max(1, ...values);

  ordered.forEach(k => {
    const val = days[k].total;
    const pct = (val / max) * 90;

    const bar = document.createElement('div');
    bar.className = 'flex flex-col items-center flex-1';
    bar.innerHTML = `
      <span class='text-[10px] text-gray-600 mb-1'>${val > 0 ? val : ''}</span>
      <div class='w-full bg-indigo-500 rounded-t' style='height:${pct}%'></div>
      <span class='text-[10px] text-gray-500 mt-1'>${days[k].label}</span>
    `;
    chart.appendChild(bar);
  });
}

// Patchable init for step 4
(function patchStep4(){
  const _oldInit = window.init;
  window.init = async function step4Init(){
    const expenses = await fetchCSV();
    const monthList = computeMonthlyTotals(expenses);
    const totalSpent = monthList.reduce((s,e)=>s+Number(e.amount||0),0);
    computeBurnRate(totalSpent);
    renderTransactions(monthList);
    setupTxCollapsible();

    renderTrend(expenses);

    if (typeof _oldInit === 'function') await _oldInit();
  };
})();
</script>


<!-- STEP 5: Category Breakdown -->
<div id="cat-card" class="bg-white p-4 rounded-xl shadow-md mb-6 border border-indigo-200">
  <h3 class="text-lg font-bold text-indigo-700 mb-3">Category Breakdown</h3>
  <div id="cat-list"></div>
</div>

<script>
function renderCategoryBreakdown(expenses) {
  const list = document.getElementById('cat-list');
  list.innerHTML = '';

  const totals = {};
  let monthTotal = 0;

  expenses.forEach(e => {
    monthTotal += Number(e.amount || 0);
    const cat = e.category || 'OTHERS';
    if (!totals[cat]) totals[cat] = 0;
    totals[cat] += Number(e.amount || 0);
  });

  const entries = Object.entries(totals).sort((a,b)=>b[1]-a[1]);
  const max = entries[0] ? entries[0][1] : 1;

  entries.forEach(([cat, amt]) => {
    const pct = (amt / max) * 90;
    const share = monthTotal ? ((amt / monthTotal) * 100).toFixed(0) : 0;

    const row = document.createElement('div');
    row.className = 'mb-3';
    row.innerHTML = `
      <div class='flex justify-between text-sm font-semibold'>
        <span>${cat} (${share}%)</span>
        <span>₹${amt}</span>
      </div>
      <div class='w-full bg-gray-200 h-3 rounded-full mt-1'>
        <div class='h-3 bg-indigo-500 rounded-full' style='width:${pct}%'></div>
      </div>
    `;
    list.appendChild(row);
  });
}

// Patchable init for step 5
(function patchStep5(){
  const _oldInit = window.init;
  window.init = async function step5Init(){
    const expenses = await fetchCSV();
    const monthList = computeMonthlyTotals(expenses);
    const totalSpent = monthList.reduce((s,e)=>s+Number(e.amount||0),0);

    computeBurnRate(totalSpent);
    renderTransactions(monthList);
    setupTxCollapsible();
    renderTrend(expenses);

    renderCategoryBreakdown(monthList);

    if (typeof _oldInit === 'function') await _oldInit();
  };
})();
</script>


<!-- STEP 6: Contribution Pie Chart (Sunny vs Deepal) -->
<div id="pie-card" class="bg-white p-4 rounded-xl shadow-md mb-6 border border-indigo-200">
  <h3 class="text-lg font-bold text-indigo-700 mb-3">Contribution (Sunny vs Deepal)</h3>
  <div id="pie-chart" class="relative w-32 h-32 mx-auto"></div>
</div>

<script>
function renderPie(sunny, deepal) {
  const total = Number(sunny||0) + Number(deepal||0);
  const chart = document.getElementById('pie-chart');
  chart.innerHTML = '';
  if (total === 0) {
    chart.innerHTML = "<p class='text-sm text-gray-500 text-center'>No data</p>";
    return;
  }

  const sunnyPct = sunny / total;
  const circ = 2 * Math.PI * 40;

  chart.innerHTML = `
    <svg viewBox='0 0 100 100' class='transform -rotate-90'>
      <circle cx='50' cy='50' r='40' stroke='#10b981' stroke-width='12' fill='none'/>
      <circle cx='50' cy='50' r='40' stroke='#ef4444' stroke-width='12' fill='none'
        stroke-dasharray='${circ * sunnyPct} ${circ}' />
    </svg>
    <div class='absolute inset-0 flex items-center justify-center font-bold text-sm'>${Math.round(sunnyPct*100)}%</div>
  `;
}

// Patchable init for step 6
(function patchStep6(){
  const _oldInit = window.init;
  window.init = async function step6Init(){
    const expenses = await fetchCSV();
    const monthList = computeMonthlyTotals(expenses);
    const totalSpent = monthList.reduce((s,e)=>s+Number(e.amount||0),0);

    computeBurnRate(totalSpent);
    renderTransactions(monthList);
    setupTxCollapsible();
    renderTrend(expenses);
    renderCategoryBreakdown(monthList);

    let sunny = 0, deepal = 0;
    monthList.forEach(e => { if (String(e.enteredBy).trim()==='Sunny') sunny += Number(e.amount||0); if (String(e.enteredBy).trim()==='Deepal') deepal += Number(e.amount||0); });
    renderPie(sunny, deepal);

    if (typeof _oldInit === 'function') await _oldInit();
  };
})();
</script>


<!-- STEP 7: Past Months History -->
<div id="hist-card" class="bg-white p-4 rounded-xl shadow-md mb-6 border border-indigo-200">
  <h3 class="text-lg font-bold text-indigo-700 mb-3">Past Months History</h3>
  <div id="hist-list"></div>
</div>

<script>
function renderHistory(expenses) {
  const hist = document.getElementById('hist-list');
  hist.innerHTML = '';

  const byMonth = {};
  expenses.forEach(e => {
    const d = new Date(e.date);
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    if (!byMonth[key]) byMonth[key] = 0;
    byMonth[key] += Number(e.amount||0);
  });

  const sorted = Object.entries(byMonth).sort((a,b)=>b[0].localeCompare(a[0]));
  const currentKey = new Date().getFullYear() + '-' + String(new Date().getMonth()+1).padStart(2,'0');

  sorted.forEach(([key, amt]) => {
    if (key === currentKey) return; // skip current month

    const d = new Date(key + '-01');
    const name = d.toLocaleString('en-US',{ month:'long', year:'numeric' });

    const row = document.createElement('div');
    row.className = 'border-b py-2';
    row.innerHTML = `
      <div class='font-semibold text-sm'>${name}</div>
      <div class='text-indigo-700 font-bold'>₹${amt}</div>
    `;
    hist.appendChild(row);
  });
}

// Patchable init for step 7 (final)
(function patchStep7(){
  const _oldInit = window.init;
  window.init = async function step7Init(){
    const expenses = await fetchCSV();
    const monthList = computeMonthlyTotals(expenses);
    const totalSpent = monthList.reduce((s,e)=>s+Number(e.amount||0),0);

    computeBurnRate(totalSpent);
    renderTransactions(monthList);
    setupTxCollapsible();
    renderTrend(expenses);
    renderCategoryBreakdown(monthList);

    let sunny = 0, deepal = 0;
    monthList.forEach(e => { if (String(e.enteredBy).trim()==='Sunny') sunny += Number(e.amount||0); if (String(e.enteredBy).trim()==='Deepal') deepal += Number(e.amount||0); });
    renderPie(sunny, deepal);

    renderHistory(expenses);

    if (typeof _oldInit === 'function') await _oldInit();
  };
})();
</script>


<!-- --- ENHANCEMENTS: Filters, Dark Mode Toggle, FAB polish, Animations, Category Budgets --- -->
<style>
  /* Simple animation helpers */
  .fade-in { animation: fadeIn 400ms ease both; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity:1; transform: translateY(0); } }

  .fab-anim { animation: pulse 2000ms infinite; }
  @keyframes pulse { 0%{ transform: translateY(0) scale(1);} 50%{ transform: translateY(-4px) scale(1.03);} 100%{ transform: translateY(0) scale(1);} }

  /* Dark mode variables */
  :root { --bg: #eef2ff; --card: #ffffff; --text: #0f172a; --muted: #6b7280; --accent: #4f46e5; }
  body.dark { --bg: #0b1220; --card: #071023; --text: #e6eef8; --muted: #94a3b8; --accent: #7c3aed; }

  body { background: var(--bg); color: var(--text); }
  .card { background: var(--card); }
  .muted { color: var(--muted); }

  /* Improved FAB look */
  .fab-upgraded { box-shadow: 0 8px 20px rgba(79,70,229,0.18); }

  /* Category color chips fallbacks */
  .cat-chip { display:inline-block; width:12px; height:12px; border-radius:3px; margin-right:6px; vertical-align:middle; }
</style>

<!-- Filters + Dark Mode Toggle -->
<div class="bg-white p-3 rounded-xl shadow-md mb-4 card fade-in" style="max-width:640px;margin:12px auto;">
  <div class="flex items-center justify-between mb-3">
    <div class="font-bold text-indigo-700">Filters</div>
    <div class="flex items-center gap-2">
      <label class="text-sm muted">Dark</label>
      <button id="dark-toggle" class="px-2 py-1 rounded bg-gray-100 text-sm">Toggle</button>
    </div>
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
    <div>
      <label class="text-xs muted">From</label>
      <input id="filter-from" type="date" class="w-full p-2 rounded border" />
    </div>
    <div>
      <label class="text-xs muted">To</label>
      <input id="filter-to" type="date" class="w-full p-2 rounded border" />
    </div>
    <div>
      <label class="text-xs muted">Category</label>
      <select id="filter-category" class="w-full p-2 rounded border"><option value="all">All</option></select>
    </div>
    <div>
      <label class="text-xs muted">Person</label>
      <select id="filter-person" class="w-full p-2 rounded border"><option value="all">All</option><option>Sunny</option><option>Deepal</option></select>
    </div>
    <div>
      <label class="text-xs muted">Min Amount</label>
      <input id="filter-min" type="number" class="w-full p-2 rounded border" placeholder="0" />
    </div>
    <div class="flex items-end">
      <button id="filter-apply" class="w-full p-2 rounded bg-indigo-600 text-white">Apply</button>
    </div>
  </div>
</div>

<!-- Upgraded FAB (INR icon) -->
<a id="fab" href="https://docs.google.com/forms/d/1hnsgJRRX_1vcoo9bmIXVzTih__gkM_ltXX5DvxLtkGc/viewform" target="_blank" class="fixed bottom-6 right-6 z-50 flex items-center justify-center w-16 h-16 bg-indigo-600 text-white rounded-full fab-upgraded fab-anim" title="Add Expense">
  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" class="transform" xmlns="http://www.w3.org/2000/svg"><path d="M12 4v16" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M20 12H4" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
</a>

<script>
// ENHANCEMENTS SCRIPT: manual dark toggle, filters wiring, category chips and animations
let ALL_EXPENSES = [];
let CURRENT_FILTERED = [];

function isoFromInputDate(value) {
  // input type=date returns YYYY-MM-DD; convert to Date object
  if (!value) return null;
  return new Date(value + 'T00:00:00');
}

function applyFiltersAndRender() {
  const from = isoFromInputDate(document.getElementById('filter-from').value);
  const to = isoFromInputDate(document.getElementById('filter-to').value);
  const cat = document.getElementById('filter-category').value;
  const person = document.getElementById('filter-person').value;
  const min = Number(document.getElementById('filter-min').value || 0);

  CURRENT_FILTERED = ALL_EXPENSES.filter(e => {
    const d = new Date(e.date);
    if (from && d < from) return false;
    if (to) {
      const toEnd = new Date(to); toEnd.setHours(23,59,59,999);
      if (d > toEnd) return false;
    }
    if (cat !== 'all' && e.category !== cat) return false;
    if (person !== 'all' && e.enteredBy !== person) return false;
    if (e.amount < min) return false;
    return true;
  });

  // Use CURRENT_FILTERED for all renderers
  const monthlyList = computeMonthlyTotals(CURRENT_FILTERED);
  const totalSpent = monthlyList.reduce((s, x) => s + x.amount, 0);
  computeBurnRate(totalSpent);
  renderTransactions(monthlyList);
  renderTrend(CURRENT_FILTERED);
  renderCategoryBreakdown(monthlyList);

  let sunny = 0, deepal = 0;
  monthlyList.forEach(e => { if (e.enteredBy==='Sunny') sunny+=e.amount; if (e.enteredBy==='Deepal') deepal+=e.amount; });
  renderPie(sunny, deepal);
  renderHistory(CURRENT_FILTERED);
}

function populateCategorySelect() {
  const sel = document.getElementById('filter-category');
  const cats = Array.from(new Set(ALL_EXPENSES.map(e=>e.category || 'OTHERS'))).sort();
  // clear existing options except 'all'
  sel.querySelectorAll('option:not([value="all"])').forEach(o=>o.remove());
  cats.forEach(c => {
    const opt = document.createElement('option'); opt.value = c; opt.textContent = c; sel.appendChild(opt);
  });
}

// Dark mode toggle
const darkToggle = document.getElementById('dark-toggle');
darkToggle.onclick = () => {
  document.body.classList.toggle('dark');
};

// Filter apply
document.getElementById('filter-apply').onclick = () => applyFiltersAndRender();

// Hook into existing init: replace with enhanced init
const __finalInit = window.init;
window.init = async function enhancedInit() {
  const expenses = await fetchCSV();
  ALL_EXPENSES = expenses.map(e => ({ ...e }));
  // ensure Date fields are in ISO-friendly format when possible
  ALL_EXPENSES.forEach(e => {
    // e.date is MM/DD/YYYY per your sheet; normalize to YYYY-MM-DD for JS Date
    try {
      const parts = String(e.date || '').split('/'); // MM/DD/YYYY
      if (parts.length === 3) {
        e.date = `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
      }
    } catch (err) { /* keep original */ }
  });

  // initial populate filters
  populateCategorySelect();
  // default render without filters
  CURRENT_FILTERED = ALL_EXPENSES.slice();
  applyFiltersAndRender();

  // call older init flow to preserve any other behaviour
  if (typeof __finalInit === 'function') await __finalInit();
};

// Run the enhanced init after a brief tick to ensure DOM is ready
setTimeout(() => { if (typeof window.init === 'function') window.init(); }, 50);
</script>

</body>
</html>
