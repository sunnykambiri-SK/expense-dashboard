<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EXPENSE TRACKER</title>

  <!-- App Icon for Home-Screen Shortcut (INR symbol) -->
  <link
    rel="icon"
    type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%230059b3'/%3E%3Ctext x='50' y='63' font-size='55' text-anchor='middle' fill='white' font-family='Arial'%3E%E2%82%B9%3C/text%3E%3C/svg%3E"
  />

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .card { box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06); }
    .collapsible-arrow { transition: transform 0.2s ease; }
    .collapsible-arrow.open { transform: rotate(90deg); }

    /* NEW BAR THICKNESS */
    .burn-bar-bg { height: 20px; }
    .burn-bar-fg { height: 20px; }
  </style>
</head>

<body class="bg-indigo-100 min-h-screen">
  <main class="max-w-xl mx-auto px-4 py-4 space-y-4">
    
    <!-- HEADER -->
    <header class="flex items-center justify-between mb-2">
      <h1 class="text-lg font-extrabold tracking-wide text-slate-900">EXPENSE TRACKER</h1>

      <div class="flex items-center gap-2">
        <div id="data-badge" class="hidden px-2 py-0.5 rounded bg-amber-500 text-white text-[10px] font-semibold uppercase">
          Sample
        </div>
        <div id="month-pill" class="px-3 py-1 rounded-md bg-orange-500 text-white text-xs font-semibold uppercase">---</div>
      </div>
    </header>

    <!-- SUMMARY -->
    <section class="card rounded-xl bg-[#f5f0e6] px-4 py-3">
      <div class="flex justify-between text-xs font-semibold text-slate-600 mb-1">
        <span>THIS MONTH</span>
      </div>
      <div class="flex gap-4">
        <div class="flex-1">
          <div class="text-xs font-semibold text-indigo-700 mb-0.5">Total Spent</div>
          <div id="summary-total" class="text-xl font-extrabold text-indigo-700">₹0</div>
        </div>
        <div class="flex-1 text-right">
          <div class="text-xs font-semibold text-slate-800 mb-0.5">Balance</div>
          <div id="summary-balance" class="text-xl font-extrabold text-black">₹0</div>
        </div>
      </div>
    </section>

    <!-- BURN RATE -->
    <section class="card rounded-xl bg-white px-4 py-3">
      <div class="flex justify-between text-[11px] text-slate-600 mb-1">
        <span>Time elapsed: <span id="burn-time">0%</span></span>
        <span>Burn: <span id="burn-spent">0%</span></span>
      </div>

      <div class="relative w-full bg-slate-200 rounded-full burn-bar-bg overflow-hidden">
        <div id="burn-time-bar" class="absolute left-0 top-0 bg-blue-400/70 burn-bar-fg rounded-full" style="width:0%"></div>
        <div id="burn-spent-bar" class="absolute left-0 top-0 burn-bar-fg rounded-full bg-emerald-500" style="width:0%"></div>
      </div>
    </section>

    <!-- LAST 10 DAYS TREND -->
    <section class="card rounded-xl bg-white px-4 py-3">
      <h2 class="text-sm font-semibold text-slate-800 mb-2">Last 10D trend</h2>
      <div id="trend-chart" class="relative flex items-end space-x-1 h-40"></div>
    </section>

    <!-- CATEGORY -->
    <section class="card rounded-xl bg-white">
      <button id="cat-header" class="w-full flex items-center justify-between px-4 py-3 text-sm font-semibold text-slate-800">
        <span>Category</span>
        <span id="cat-arrow" class="collapsible-arrow text-slate-500">▶</span>
      </button>
      <div id="cat-body" class="border-t border-slate-100 px-4 py-2 hidden">
        <div id="cat-list" class="space-y-2"></div>
      </div>
    </section>

    <!-- RECENT TRANSACTIONS -->
    <section class="card rounded-xl bg-white">
      <button id="tx-header" class="w-full flex items-center justify-between px-4 py-3 text-sm font-semibold text-slate-800">
        <span>Recent Transactions</span>
        <span id="tx-arrow" class="collapsible-arrow text-slate-500">▶</span>
      </button>
      <div id="tx-body" class="border-t border-slate-100 px-4 py-2 hidden">
        <table class="w-full text-[11px]">
          <tbody id="tx-table-body"></tbody>
        </table>
      </div>
    </section>

    <!-- CONTRIBUTION -->
    <section class="card rounded-xl bg-white px-4 py-3">
      <h2 class="text-sm font-semibold text-slate-800 mb-2">Contribution</h2>
      <div class="flex justify-between text-[11px] text-slate-400 mb-1">
        <span>Sunny</span><span>Deepal</span>
      </div>
      <div id="contri-bar-wrapper" class="w-full h-5 bg-slate-200 rounded-full overflow-hidden flex"></div>
    </section>

    <!-- HISTORY -->
    <section class="card rounded-xl bg-white">
      <button id="hist-header" class="w-full flex items-center justify-between px-4 py-3 text-sm font-semibold text-slate-800">
        <span>History</span><span id="hist-arrow" class="collapsible-arrow text-slate-500">▶</span>
      </button>
      <div id="hist-body" class="border-t border-slate-100 px-4 py-2 hidden">
        <div id="hist-list" class="text-xs space-y-1"></div>
      </div>
    </section>

    <!-- FILTERS -->
    <section class="card rounded-xl bg-white">
      <button id="filter-header" class="w-full flex items-center justify-between px-4 py-3 text-sm font-semibold text-slate-800">
        <span>Filters</span><span id="filter-arrow" class="collapsible-arrow text-slate-500">▶</span>
      </button>
      <div id="filter-body" class="border-t border-slate-100 px-4 py-3 hidden">
        <div class="grid grid-cols-2 gap-2 text-[11px]">
          <input id="filter-from" type="date" class="border px-1 rounded"/>
          <input id="filter-to" type="date" class="border px-1 rounded"/>
          <select id="filter-category" class="border px-2 rounded"><option value="all">All</option></select>
          <select id="filter-person" class="border px-2 rounded">
            <option value="all">All</option><option>Sunny</option><option>Deepal</option>
          </select>
          <input id="filter-min" type="number" placeholder="Min" class="border px-1 rounded"/>
          <button id="filter-apply" class="bg-indigo-600 text-white rounded px-3 py-1">Apply</button>
        </div>
      </div>
    </section>

    <!-- FLOATING ADD BUTTON -->
    <a href="https://docs.google.com/forms/d/1hnsgJRRX_1vcoo9bmIXVzTih__gkM_ltXX5DvxLtkGc/viewform"
       class="fixed bottom-6 right-6 w-14 h-14 rounded-full bg-indigo-600 text-white flex items-center justify-center shadow-xl">+</a>
  </main>


<script>
/* ---------------- CONFIG ---------------- */
const G_SHEET_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vSg2yv6cZgH_d8f7gFlb3P44ZO3_DubKK0kzmnlDYdOkB2hWwv3TVUWUPnywnhG-_ECKvqUE21-aCRC/pub?output=csv";

const MONTHLY_BUDGET = 50000;
const DAILY_LIMIT = 2000;

const SAMPLE_CSV = `Timestamp,What,Amount,By,Date,Category
12/2/2025 23:19:46,Food,300,Sunny,12/2/2025,Food`;

let ALL = [];

/* -------- CSV PARSER -------- */
function parseCSV(text){
  const rows = text.split(/\r?\n/).slice(1);
  return rows.map(r=>{
    const [ts,d,a,b,dt,c] = r.split(",");
    return {
      timestamp:ts,
      title:d,
      amount:+a||0,
      by:b,
      dateISO:normalize(dt),
      category:c||"Other"
    };
  });
}

function normalize(d){
  const [m,x,y]=d.split("/");
  return `${y}-${m.padStart(2,"0")}-${x.padStart(2,"0")}`;
}

/* -------- UI RENDERS -------- */

function renderSummary(list){
  const total=list.reduce((s,e)=>s+e.amount,0);
  document.getElementById("summary-total").textContent="₹"+total.toLocaleString("en-IN");
  document.getElementById("summary-balance").textContent="₹"+(MONTHLY_BUDGET-total).toLocaleString("en-IN");
}

function renderBurn(list){
  const spent=list.reduce((s,e)=>s+e.amount,0);
  const d=new Date();
  const pctTime=Math.round((d.getDate()/new Date(d.getFullYear(),d.getMonth()+1,0).getDate())*100);
  const pctSpent=Math.round((spent/MONTHLY_BUDGET)*100);

  document.getElementById("burn-time").textContent=pctTime+"%";
  document.getElementById("burn-spent").textContent=pctSpent+"%";

  document.getElementById("burn-time-bar").style.width = pctTime+"%";
  const s=document.getElementById("burn-spent-bar");
  s.style.width=pctSpent+"%";
  s.classList.toggle("bg-red-500",pctSpent>pctTime);
}

function renderTrend(list){
  const box=document.getElementById("trend-chart");
  box.innerHTML="";

  const today=new Date(); today.setHours(0,0,0,0);

  const totals={};
  list.forEach(e=>{
    const d=new Date(e.dateISO); d.setHours(0,0,0,0);
    const key=d.toISOString().slice(0,10);
    totals[key]=(totals[key]||0)+e.amount;
  });

  const data=[];
  for(let i=9;i>=0;i--){
    const d=new Date(today); d.setDate(today.getDate()-i);
    const key=d.toISOString().slice(0,10);
    data.push({label:`${String(d.getDate()).padStart(2,"0")}/${d.getMonth()+1}`,val:totals[key]||0});
  }

  const max=Math.max(...data.map(d=>d.val),1);

  data.forEach(d=>{
    const wrap=document.createElement("div");
    wrap.className="flex flex-col items-center flex-1 h-full";

    const lbl=document.createElement("div");
    lbl.textContent=d.val?d.val.toLocaleString("en-IN"):"";
    lbl.className="text-[10px] text-slate-600";
    lbl.style.transform="rotate(-90deg)";
    wrap.append(lbl);

    const col=document.createElement("div");
    col.className=`w-[60%] rounded-t ${d.val>DAILY_LIMIT?'bg-red-500':'bg-indigo-500'}`;
    col.style.height=(d.val/max*80)+"%";
    wrap.append(col);

    const date=document.createElement("span");
    date.textContent=d.label;
    date.className="text-[10px] text-slate-500 mt-1";
    wrap.append(date);

    box.append(wrap);
  });
}

function renderContribution(list){
  const wrap=document.getElementById("contri-bar-wrapper");
  wrap.innerHTML="";
  let s=0,d=0;
  list.forEach(e=>{ if(e.by==="Sunny")s+=e.amount; if(e.by==="Deepal")d+=e.amount; });
  const t=s+d; if(!t){wrap.textContent="No data";return;}

  const l=document.createElement("div");
  l.style.width=(s/t*100)+"%"; l.className="h-full bg-red-500 flex items-center justify-center text-white text-[10px]";
  l.textContent=Math.round(s/t*100)+"%";
  const r=document.createElement("div");
  r.style.width=(d/t*100)+"%"; r.className="h-full bg-emerald-500 flex items-center justify-center text-white text-[10px]";
  r.textContent=Math.round(d/t*100)+"%";
  wrap.append(l,r);
}

/* -------- COLLAPSIBLES -------- */
function setupToggles(){
  ["cat","tx","hist","filter"].forEach(id=>{
    const btn=document.getElementById(id+"-header");
    const body=document.getElementById(id+"-body");
    const arrow=document.getElementById(id+"-arrow");
    btn.addEventListener("click",()=>{
      body.classList.toggle("hidden");
      arrow.classList.toggle("open");
    });
  });
}

/* -------- DOWNLOAD + LOAD -------- */

async function load(){
  let csv, fallback=false;
  try{
    const r=await fetch(G_SHEET_URL,{cache:"no-store"});
    csv=await r.text();
  }catch{
    csv=SAMPLE_CSV;
    fallback=true;
  }
  if(fallback)document.getElementById("data-badge").classList.remove("hidden");
  ALL=parseCSV(csv);
}

/* -------- INIT -------- */
async function init(){
  await load();
  const month=ALL.filter(e=>new Date(e.dateISO).getMonth()===new Date().getMonth());
  renderSummary(month);
  renderBurn(month);
  renderTrend(ALL);
  renderContribution(month);

  setupToggles();

  document.getElementById("filter-apply").onclick=()=>{
    location.reload();
  };
}

init();
</script>

</body>
</html>
